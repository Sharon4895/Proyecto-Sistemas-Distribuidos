<div class="fade-in max-w-7xl mx-auto p-4">
    <button routerLink="/admin/dashboard" class="mb-4 text-gray-500 hover:text-blue-600 flex items-center gap-2 font-medium transition-colors border-none bg-transparent cursor-pointer">
        <i class="pi pi-arrow-left"></i> Volver al Dashboard
    </button>
    
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800">Gestión de Usuarios</h1>
        <p class="text-gray-500">Administra y audita las cuentas registradas en el sistema</p>
    </div>

    <div class="card bg-white rounded-xl shadow-sm border border-gray-200 p-4">
        
        <p-table 
            #dt1 
            [value]="users" 
            [paginator]="true" 
            [rows]="10" 
            [loading]="loading"
            [globalFilterFields]="['name','curp']"
            styleClass="p-datatable-striped"
            responsiveLayout="scroll">
            
            <ng-template pTemplate="caption">
                <div class="flex flex-column md:flex-row justify-between items-center gap-3">
                    <button pButton label="Actualizar" icon="pi pi-refresh" class="p-button-outlined p-button-sm" (click)="loadUsers()"></button>
                    
                    <span class="p-input-icon-left w-full md:w-auto">
                        <i class="pi pi-search"></i>
                        <input 
                            pInputText 
                            type="text" 
                            (input)="dt1.filterGlobal($any($event.target).value, 'contains')" 
                            placeholder="Buscar por nombre o CURP" 
                            class="w-full md:w-64" />
                    </span>
                </div>
            </ng-template>

            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="name">Usuario <p-sortIcon field="name"></p-sortIcon></th>
                    <th>CURP</th>
                    <th pSortableColumn="balance">Saldo Actual <p-sortIcon field="balance"></p-sortIcon></th>
                    <th>Estado</th>
                    <th class="text-center">Auditoría</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-user>
                <tr>
                    <td class="font-bold text-gray-700">{{ user.name }}</td>
                    <td class="text-gray-500 font-mono text-sm">{{ user.curp }}</td>
                    <td class="font-bold text-green-600">{{ user.balance | currency:'MXN' }}</td>
                    <td>
                        <p-tag 
                            [value]="getUserStatus(user.balance)" 
                            [severity]="getUserStatus(user.balance) === 'ACTIVO' ? 'success' : 'danger'">
                        </p-tag>
                    </td>
                    <td class="text-center">
                        <button 
                            pButton 
                            icon="pi pi-eye" 
                            class="p-button-rounded p-button-text p-button-secondary" 
                            pTooltip="Ver Logs / Auditoría" 
                            tooltipPosition="top"
                            (click)="viewUserLogs(user)">
                        </button>
                    </td>
                </tr>
            </ng-template>
            
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="5" class="text-center p-4 text-gray-400">No se encontraron usuarios.</td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <p-dialog 
        [(visible)]="displayDialog" 
        [header]="'Auditoría: ' + (selectedUser?.name || '')" 
        [modal]="true" 
        [style]="{width: '90vw', maxWidth: '700px'}"
        [draggable]="false" 
        [resizable]="false"
        [dismissableMask]="true">
        
        <div class="mb-4 bg-blue-50 p-4 rounded-lg flex flex-wrap justify-between items-center border border-blue-100">
            <span class="text-sm text-gray-600">CURP: <span class="font-bold font-mono">{{ selectedUser?.curp }}</span></span>
            <span class="text-sm text-gray-600">Saldo: <span class="font-bold text-green-600 text-lg">{{ selectedUser?.balance | currency:'MXN' }}</span></span>
        </div>

        <p-table [value]="userTransactions" [rows]="5" [paginator]="true" styleClass="p-datatable-sm" responsiveLayout="scroll">
            <ng-template pTemplate="header">
                <tr>
                    <th class="text-xs uppercase text-gray-500">Fecha</th>
                    <th class="text-xs uppercase text-gray-500">Tipo</th>
                    <th class="text-xs uppercase text-gray-500">Descripción</th>
                    <th class="text-xs uppercase text-gray-500 text-right">Monto</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-log>
                <tr>
                    <td class="text-xs text-gray-500">{{ log.date | date:'short' }}</td>
                    <td>
                        <span class="font-bold text-[10px] px-2 py-1 rounded bg-gray-100 text-gray-600">
                            {{ log.type }}
                        </span>
                    </td>
                    <td class="text-sm text-gray-700">{{ log.description }}</td>
                    <td class="text-right">
                        <span [ngClass]="{'text-green-600': log.type==='DEPOSIT' || log.type==='TRANSFER_RECEIVED', 'text-red-600': log.type==='WITHDRAW' || log.type==='TRANSFER_SENT'}" class="font-bold text-sm">
                            {{ log.type==='WITHDRAW' || log.type==='TRANSFER_SENT' ? '-' : '+' }}{{ log.amount | currency:'MXN' }}
                        </span>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="4" class="text-center p-4 text-gray-400 italic">Este usuario no tiene movimientos registrados.</td>
                </tr>
            </ng-template>
        </p-table>

        <ng-template pTemplate="footer">
            <button pButton label="Cerrar" icon="pi pi-times" class="p-button-text" (click)="displayDialog = false"></button>
        </ng-template>
    </p-dialog>
</div>